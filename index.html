<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StarPay ‚Äî –ü–æ–∫—É–ø–∫–∞ Telegram Stars</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Roboto+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --tg-bg-color: #FFFFFF;
            --tg-secondary-bg-color: #F8F8F8;
            --tg-text-color: #000000;
            --tg-secondary-text-color: #666666;
            --tg-hint-color: #999999;
            --tg-link-color: #000000;
            --tg-button-color: #000000;
            --tg-button-text-color: #FFFFFF;
            --tg-border-color: #E0E0E0;
            --tg-card-bg: #FFFFFF;
            --tg-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --tg-input-bg: #FFFFFF;
            --primary-black: #000000;
            --secondary-black: #333333;
            --primary-white: #FFFFFF;
            --secondary-gray: #F0F0F0;
            --success-color: #10B981;
            --error-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
            --star-color: #FFD700;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }
        
        .theme-dark {
            --tg-bg-color: #000000;
            --tg-secondary-bg-color: #1A1A1A;
            --tg-text-color: #FFFFFF;
            --tg-secondary-text-color: #CCCCCC;
            --tg-hint-color: #888888;
            --tg-link-color: #FFFFFF;
            --tg-button-color: #FFFFFF;
            --tg-button-text-color: #000000;
            --tg-border-color: #333333;
            --tg-card-bg: #1A1A1A;
            --tg-shadow: 0 2px 12px rgba(255, 255, 255, 0.1);
            --tg-input-bg: #2A2A2A;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 100%;
            padding: 16px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--tg-border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 800;
            color: var(--tg-text-color);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-black) 0%, var(--secondary-black) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .theme-dark .logo-icon {
            background: linear-gradient(135deg, var(--primary-white) 0%, var(--secondary-gray) 100%);
            color: black;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .balance {
            background: var(--tg-card-bg);
            border: 1px solid var(--tg-border-color);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-weight: 700;
            font-size: 20px;
            color: var(--tg-text-color);
            box-shadow: var(--tg-shadow);
            min-width: 100px;
            text-align: center;
        }
        
        .main-content {
            padding-bottom: 20px;
        }
        
        .section {
            background: var(--tg-card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--tg-border-color);
            box-shadow: var(--tg-shadow);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--tg-text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--tg-text-color);
            font-size: 22px;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            background: var(--tg-secondary-bg-color);
            padding: 6px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            flex: 0 0 auto;
            padding: 12px 16px;
            border: none;
            background: transparent;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--tg-secondary-text-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            background: var(--tg-card-bg);
            color: var(--tg-text-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--tg-border-color);
        }
        
        .theme-dark .tab.active {
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
        }
        
        .rate-info {
            background: var(--tg-secondary-bg-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--tg-border-color);
        }
        
        .rate-title {
            font-size: 14px;
            color: var(--tg-secondary-text-color);
            margin-bottom: 8px;
        }
        
        .rate-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--tg-text-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            color: var(--tg-text-color);
        }
        
        .form-input {
            width: 100%;
            padding: 16px;
            background: var(--tg-input-bg);
            border: 2px solid var(--tg-border-color);
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            color: var(--tg-text-color);
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--tg-text-color);
        }
        
        .form-hint {
            display: block;
            margin-top: 6px;
            font-size: 13px;
            color: var(--tg-hint-color);
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            background: var(--tg-button-color);
            color: var(--tg-button-text-color);
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: var(--tg-secondary-bg-color);
            color: var(--tg-text-color);
            border: 1px solid var(--tg-border-color);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .calculation {
            background: var(--tg-secondary-bg-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .calculation-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        .calculation-row.total {
            font-size: 18px;
            font-weight: 700;
            border-top: 1px solid var(--tg-border-color);
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .history-item {
            background: var(--tg-card-bg);
            border: 1px solid var(--tg-border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: transform 0.2s ease;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--tg-text-color);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .history-subtitle {
            font-size: 14px;
            color: var(--tg-secondary-text-color);
        }
        
        .history-amount {
            font-weight: 700;
            font-size: 18px;
            text-align: right;
        }
        
        .history-amount.positive {
            color: var(--success-color);
        }
        
        .history-amount.negative {
            color: var(--error-color);
        }
        
        .history-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error-color);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--tg-card-bg);
            border: 1px solid var(--tg-border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 90%;
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--tg-card-bg);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px;
            background: var(--tg-button-color);
            color: var(--tg-button-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--tg-button-text-color);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .footer {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--tg-border-color);
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .footer-link {
            color: var(--tg-link-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .footer-text {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
            color: var(--tg-hint-color);
        }
        
        .stars-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .star-icon {
            color: var(--star-color);
        }
        
        .calculator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .calc-btn {
            padding: 12px;
            background: var(--tg-secondary-bg-color);
            border: 1px solid var(--tg-border-color);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .calc-btn:hover {
            background: var(--tg-border-color);
        }
        
        .calc-btn.active {
            background: var(--tg-button-color);
            color: var(--tg-button-text-color);
            border: 1px solid var(--tg-button-color);
        }
        
        .admin-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--tg-border-color);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .admin-table th {
            text-align: left;
            padding: 12px;
            background: var(--tg-secondary-bg-color);
            border-bottom: 2px solid var(--tg-border-color);
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid var(--tg-border-color);
            font-size: 14px;
            vertical-align: top;
        }
        
        .admin-table tr:hover {
            background: var(--tg-secondary-bg-color);
        }
        
        .transaction-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .type-stars {
            background: rgba(255, 215, 0, 0.1);
            color: var(--star-color);
        }
        
        .type-topup {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--tg-secondary-bg-color);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--tg-text-color);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--tg-secondary-text-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            color: var(--tg-hint-color);
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state p {
            color: var(--tg-secondary-text-color);
            font-size: 16px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            .section {
                padding: 16px;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--tg-border-color);
            border-top-color: var(--tg-button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="agreementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</div>
                <button class="modal-close" onclick="closeModal('agreementModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="document-content">
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ StarPay</h3>
                    <p><strong>–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —Å–∏–ª—É:</strong> 1 —è–Ω–≤–∞—Ä—è 2026 –≥–æ–¥–∞</p>
                    
                    <h4>1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</h4>
                    <p>StarPay - —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∏ –æ–±–º–µ–Ω–∞ Telegram Stars.</p>
                    
                    <h4>2. –ö—É—Ä—Å –æ–±–º–µ–Ω–∞</h4>
                    <p>1 Telegram Star = 1.1 RUB. –ö—É—Ä—Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å—Å—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
                    
                    <h4>3. –ü–æ–∫—É–ø–∫–∞ Stars</h4>
                    <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞: 10 Stars. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞: 100,000 Stars.</p>
                    
                    <h4>4. –ö–æ–º–∏—Å—Å–∏–∏</h4>
                    <p>–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø–æ–∫—É–ø–∫—É: 1.5% –æ—Ç —Å—É–º–º—ã.</p>
                    <p>–°—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫: 1-7 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.</p>
                    
                    <h4>5. –ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <p>–ü–æ–¥–¥–µ—Ä–∂–∫–∞: starpay@mail.ru</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆMoney</div>
                <button class="modal-close" onclick="closeModal('paymentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="text-center" style="padding: 20px 0;">
                    <i class="fas fa-external-link-alt" style="font-size: 48px; color: var(--tg-text-color); margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 16px;">–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã</h3>
                    <p style="color: var(--tg-secondary-text-color); margin-bottom: 24px;">
                        –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ÆMoney –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.
                    </p>
                    <div style="background: var(--tg-secondary-bg-color); padding: 16px; border-radius: var(--radius-md); margin-bottom: 24px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è —á–µ–∫–∞:</div>
                        <div style="font-family: 'Roboto Mono', monospace; font-size: 18px;" id="payment-card-number">**** **** **** ****</div>
                    </div>
                    <button class="btn" onclick="redirectToPayment()">
                        <i class="fas fa-external-link-alt"></i>
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                    </button>
                    <button class="btn btn-secondary mt-3" onclick="closeModal('paymentModal')">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <button class="modal-close" onclick="closeModal('editBalanceModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="edit-balance-info" style="margin-bottom: 20px;">
                    <div style="background: var(--tg-secondary-bg-color); padding: 16px; border-radius: var(--radius-md);">
                        <div style="margin-bottom: 8px;"><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="edit-user-name">-</span></div>
                        <div style="margin-bottom: 8px;"><strong>Username:</strong> <span id="edit-user-username">-</span></div>
                        <div><strong>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</strong> <span id="edit-current-balance">0.00 ‚ÇΩ</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å (‚ÇΩ)</label>
                    <input type="number" class="form-input" id="new-balance-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="balance-change-reason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–æ–Ω—É—Å –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å">
                </div>
                <button class="btn btn-success" onclick="saveUserBalance()">
                    <i class="fas fa-save"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
                <button class="btn btn-secondary mt-3" onclick="closeModal('editBalanceModal')">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <div class="notification-icon" id="notification-icon">üí´</div>
        <div class="notification-content">
            <div class="notification-title" id="notification-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
            <p class="notification-text" id="notification-text">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">‚òÖ</div>
                <span>StarPay</span>
            </div>
            <div class="user-info">
                <div class="balance" id="balance">0 ‚ÇΩ</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="rate-info">
                <div class="rate-title">–ö—É—Ä—Å Telegram Stars</div>
                <div class="rate-value">1 STAR = 1.1 ‚ÇΩ</div>
            </div>
            
            <div class="tabs" id="main-tabs">
                <button class="tab active" onclick="showSection('buy')">–ö—É–ø–∏—Ç—å Stars</button>
                <button class="tab" onclick="showSection('topup')">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                <button class="tab" onclick="showSection('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="tab" onclick="showSection('about')">–û —Å–µ—Ä–≤–∏—Å–µ</button>
            </div>
            
            <div id="buy-section" class="section">
                <div class="section-title">
                    <i class="fas fa-star"></i>
                    <span>–ü–æ–∫—É–ø–∫–∞ Telegram Stars</span>
                </div>
                
                <div class="calculator">
                    <div class="calc-btn" onclick="setStarsAmount(100)">100</div>
                    <div class="calc-btn" onclick="setStarsAmount(500)">500</div>
                    <div class="calc-btn" onclick="setStarsAmount(1000)">1000</div>
                    <div class="calc-btn" onclick="setStarsAmount(5000)">5000</div>
                </div>
                
                <form id="buy-form">
                    <div class="form-group">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Stars</label>
                        <input type="number" class="form-input" id="stars-amount" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="100" max="100000" value="100" required>
                        <span class="form-hint">–ú–∏–Ω–∏–º—É–º: 100 Stars, –º–∞–∫—Å–∏–º—É–º: 100,000 Stars</span>
                    </div>
                    
                    <div class="calculation">
                        <div class="calculation-row">
                            <span>–°—Ç–æ–∏–º–æ—Å—Ç—å Stars:</span>
                            <span id="stars-cost">110.00 ‚ÇΩ</span>
                        </div>
                        <div class="calculation-row">
                            <span>–ö–æ–º–∏—Å—Å–∏—è (1.5%):</span>
                            <span id="commission">1.65 ‚ÇΩ</span>
                        </div>
                        <div class="calculation-row total">
                            <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                            <span id="total-cost">111.65 ‚ÇΩ</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-shopping-cart"></i>
                        –ö—É–ø–∏—Ç—å Stars
                    </button>
                </form>
                
                <div id="buy-result" class="section mt-4 hidden">
                    <div class="section-title">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        <span>Stars –∫—É–ø–ª–µ–Ω—ã!</span>
                    </div>
                    <div class="stars-display">
                        <i class="fas fa-star star-icon"></i>
                        <span id="purchased-stars">100</span>
                        <span>Stars</span>
                    </div>
                    <div style="text-align: center; margin-bottom: 20px; color: var(--tg-secondary-text-color);">
                        –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω Telegram Stars
                    </div>
                    <button class="btn btn-secondary" onclick="showSection('history')">
                        <i class="fas fa-history"></i>
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                </div>
            </div>
            
            <div id="topup-section" class="section hidden">
                <div class="section-title">
                    <i class="fas fa-wallet"></i>
                    <span>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span>
                </div>
                
                <div class="info-box" style="background: rgba(59, 130, 246, 0.1); border: 1px solid var(--info-color); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="color: var(--info-color);"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--info-color); margin-bottom: 4px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏</div>>
                    </div>
                </div>
                
                <form id="topup-form">
                    <div class="form-group">
                        <label class="form-label">–ù–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã</label>
                        <input type="text" class="form-input" id="topup-card-number" placeholder="0000 0000 0000 0000" maxlength="19" required>
                        <span class="form-hint">–í–≤–µ–¥–∏—Ç–µ 16-19 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</span>
                    </div>
                    
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-credit-card"></i>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –∏ –æ–ø–ª–∞—Ç–∏—Ç—å
                    </button>
                </form>
                
                <div id="topup-result" class="section mt-4 hidden">
                    <div class="section-title">
                        <i class="fas fa-clock" style="color: var(--warning-color);"></i>
                        <span>–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞</span>
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success-color); margin-bottom: 16px;"></i>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">
                            –ó–∞—è–≤–∫–∞ ‚Ññ<span id="topup-request-id">0001</span>
                        </div>
                        <div style="color: var(--tg-secondary-text-color); margin-bottom: 20px;">
                            –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                        </div>
                        <button class="btn btn-secondary" onclick="showSection('history')">
                            <i class="fas fa-history"></i>
                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–æ–∫
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="history-section" class="section hidden">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    <span>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</span>
                </div>
                
                <div id="history-content">
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <p>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞</p>
                        <p class="text-muted mt-2">–ö—É–ø–∏—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ Telegram Stars</p>
                    </div>
                </div>
            </div>
            
            <div id="admin-section" class="section hidden">
                <div class="section-title">
                    <i class="fas fa-user-shield"></i>
                    <span>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
                    <span style="font-size: 12px; color: var(--tg-secondary-text-color); margin-left: auto;">
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="admin-username">@iwnel</strong>
                    </span>
                </div>
                
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab active" onclick="showAdminSection('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    <button class="tab" onclick="showAdminSection('transactions')">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button>
                    <button class="tab" onclick="showAdminSection('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                </div>
                
                <div id="admin-stats-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-transactions">0</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-stars">0</div>
                            <div class="stat-label">–ü—Ä–æ–¥–∞–Ω–æ Stars</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-revenue">0 ‚ÇΩ</div>
                            <div class="stat-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="loadAdminStats()" style="width: auto; padding: 12px 24px;">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        </button>
                    </div>
                </div>
                
                <div id="admin-transactions-section" class="hidden">
                    <div class="mb-4" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="loadAdminTransactions('all')" style="flex: 1; min-width: 120px;">
                            –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                        </button>
                        <button class="btn btn-secondary" onclick="loadAdminTransactions('stars')" style="flex: 1; min-width: 120px;">
                            –ü–æ–∫—É–ø–∫–∏ Stars
                        </button>
                        <button class="btn btn-secondary" onclick="loadAdminTransactions('topup')" style="flex: 1; min-width: 120px;">
                            –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                    
                    <div id="admin-transactions-content">
                        <div class="empty-state">
                            <i class="fas fa-database"></i>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</p>
                        </div>
                    </div>
                </div>
                
                <div id="admin-users-section" class="hidden">
                    <div class="mb-4">
                        <button class="btn btn-success" onclick="loadAdminUsers()" style="width: auto; padding: 12px 24px;">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        </button>
                    </div>
                    
                    <div id="admin-users-content">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="about-section" class="section hidden">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    <span>–û —Å–µ—Ä–≤–∏—Å–µ StarPay</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 12px; font-size: 18px;">–ß—Ç–æ —Ç–∞–∫–æ–µ Telegram Stars?</h4>
                    <p style="color: var(--tg-secondary-text-color); margin-bottom: 16px;">
                        Telegram Stars ‚Äî —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ Telegram, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ NFT –∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –æ—Ç Telegram, –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞–≤—Ç–æ—Ä–æ–≤ –∏ –æ–ø–ª–∞—Ç—ã —É—Å–ª—É–≥ –≤ –±–æ—Ç–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 16px; background: var(--tg-secondary-bg-color); border-radius: var(--radius-md);">
                        <i class="fas fa-bolt" style="font-size: 24px; color: var(--tg-text-color); margin-bottom: 8px;"></i>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">–ù–∏–∑–∫–∞—è —Ü–µ–Ω–∞</div>
                        <div style="font-size: 12px; color: var(--tg-secondary-text-color);">–°–∞–º–∞—è –Ω–∏–∑–∫–∞—è —Ü–µ–Ω–∞ –Ω–∞ Stars —Å—Ä–µ–¥–∏ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</div>
                    </div>
                    
                    <div style="text-align: center; padding: 16px; background: var(--tg-secondary-bg-color); border-radius: var(--radius-md);">
                        <i class="fas fa-shield-alt" style="font-size: 24px; color: var(--tg-text-color); margin-bottom: 8px;"></i>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</div>
                        <div style="font-size: 12px; color: var(--tg-secondary-text-color);">–ó–∞—â–∏—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
                    </div>
                    
                    <div style="text-align: center; padding: 16px; background: var(--tg-secondary-bg-color); border-radius: var(--radius-md);">
                        <i class="fas fa-percent" style="font-size: 24px; color: var(--tg-text-color); margin-bottom: 8px;"></i>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">–ù–∏–∑–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è</div>
                        <div style="font-size: 12px; color: var(--tg-secondary-text-color);">–í—Å–µ–≥–æ 1.5%</div>
                    </div>
                    
                    <div style="text-align: center; padding: 16px; background: var(--tg-secondary-bg-color); border-radius: var(--radius-md);">
                        <i class="fas fa-headset" style="font-size: 24px; color: var(--tg-text-color); margin-bottom: 8px;"></i>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        <div style="font-size: 12px; color: var(--tg-secondary-text-color);">24/7 –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                    </div>
                </div>
                
                <div style="background: var(--tg-secondary-bg-color); border-radius: var(--radius-md); padding: 16px;">
                    <h4 style="margin-bottom: 12px; font-size: 16px;">–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Stars?</h4>
                    <ul style="color: var(--tg-secondary-text-color); padding-left: 20px;">
                        <li style="margin-bottom: 8px;">–ü–æ–∫—É–ø–∫–∞ NFT –∏ –ø–æ–¥–∞—Ä–æ–≤</li>
                        <li style="margin-bottom: 8px;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ—Ä–æ–≤ –∫–∞–Ω–∞–ª–æ–≤</li>
                        <li style="margin-bottom: 8px;">–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥ –≤ –±–æ—Ç–∞—Ö</li>
                        <li>–ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–æ–∫</li>
                    </ul>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
    // Telegram WebApp API
    let tg = window.Telegram.WebApp;
    
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
        apiKey: "AIzaSyBaxoVYKmWtLgmTcM0AS5acQ1TN8qKyFfA",
        authDomain: "cashcheck-7e5c6.firebaseapp.com",
        projectId: "cashcheck-7e5c6",
        storageBucket: "cashcheck-7e5c6.firebasestorage.app",
        messagingSenderId: "706696825244",
        appId: "1:706696825244:web:e8de79e5cdae5df9606059"
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    let app, db;
    try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
        showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let userBalance = 0;
    let userTransactions = [];
    const STAR_RATE = 1.1;
    let currentTopupCard = '';
    let isAdmin = false;
    let editingUserId = null;
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function initTheme() {
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('theme-dark');
        }
        
        tg.onEvent('themeChanged', () => {
            if (tg.colorScheme === 'dark') {
                document.body.classList.add('theme-dark');
            } else {
                document.body.classList.remove('theme-dark');
            }
        });
    }
    
    function showNotification(title, message, type = 'info') {
        const notification = document.getElementById('notification');
        const titleElement = document.getElementById('notification-title');
        const textElement = document.getElementById('notification-text');
        const iconElement = document.getElementById('notification-icon');
        
        titleElement.textContent = title;
        textElement.textContent = message;
        
        switch(type) {
            case 'success':
                iconElement.textContent = '‚úÖ';
                break;
            case 'error':
                iconElement.textContent = '‚ùå';
                break;
            case 'warning':
                iconElement.textContent = '‚ö†Ô∏è';
                break;
            default:
                iconElement.textContent = 'üí´';
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    function updateBalance() {
        const balanceElement = document.getElementById('balance');
        if (balanceElement) {
            balanceElement.textContent = userBalance.toFixed(2).replace('.', ',') + ' ‚ÇΩ';
        }
    }
    
    function showSection(sectionId) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
        const targetSection = document.getElementById(`${sectionId}-section`);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∞–±
        const tabButtons = document.querySelectorAll('.tab');
        tabButtons.forEach((tab) => {
            if (tab.getAttribute('onclick')?.includes(sectionId)) {
                tab.classList.add('active');
            }
        });
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å–µ–∫—Ü–∏–∏
        if (sectionId === 'history') {
            updateHistory();
        } else if (sectionId === 'admin' && isAdmin) {
            loadAdminStats();
            showAdminSection('stats');
        }
    }
    
    function showAdminSection(sectionName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–¥—Å–µ–∫—Ü–∏–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
        ['stats', 'transactions', 'users'].forEach(section => {
            const elem = document.getElementById(`admin-${section}-section`);
            if (elem) elem.classList.add('hidden');
        });
        
        // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –ø–æ–¥—Ç–∞–±–æ–≤
        document.querySelectorAll('#admin-section .tabs .tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥—Å–µ–∫—Ü–∏—é
        const targetSection = document.getElementById(`admin-${sectionName}-section`);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–æ–¥—Ç–∞–±
        document.querySelectorAll('#admin-section .tabs .tab').forEach((tab) => {
            if (tab.getAttribute('onclick')?.includes(sectionName)) {
                tab.classList.add('active');
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        if (sectionName === 'transactions') {
            loadAdminTransactions('all');
        } else if (sectionName === 'users') {
            loadAdminUsers();
        }
    }
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
    }
    
    function updateStarsCost() {
        const starsInput = document.getElementById('stars-amount');
        let stars = parseInt(starsInput.value) || 0;
        
        if (stars < 10) stars = 10;
        if (stars > 100000) stars = 100000;
        
        const cost = stars * STAR_RATE;
        const commission = cost * 0.015;
        const total = cost + commission;
        
        document.getElementById('stars-cost').textContent = cost.toFixed(2).replace('.', ',') + ' ‚ÇΩ';
        document.getElementById('commission').textContent = commission.toFixed(2).replace('.', ',') + ' ‚ÇΩ';
        document.getElementById('total-cost').textContent = total.toFixed(2).replace('.', ',') + ' ‚ÇΩ';
    }
    
    function setStarsAmount(amount) {
        document.getElementById('stars-amount').value = amount;
        updateStarsCost();
        
        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }
    
    // –†–∞–±–æ—Ç–∞ —Å Firebase
    async function initUser() {
        try {
            const tgUser = tg.initDataUnsafe?.user;
            if (!tgUser) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
            
            const userId = `tg_${tgUser.id}`;
            currentUser = {
                id: userId,
                name: tgUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                telegramId: tgUser.id,
                username: tgUser.username || null
            };
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            isAdmin = currentUser.username === 'iwnel';
            
            if (isAdmin) {
                addAdminTab();
                document.getElementById('admin-username').textContent = `@${currentUser.username}`;
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (db) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 0;
                    userTransactions = userData.transactions || [];
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const newUser = {
                        ...currentUser,
                        balance: 0,
                        transactions: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        registrationDate: new Date().toISOString()
                    };
                    await db.collection('users').doc(userId).set(newUser);
                    showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', '–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                }
            }
            
            updateBalance();
            updateHistory();
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }
    
    function addAdminTab() {
        const tabsContainer = document.getElementById('main-tabs');
        
        const adminTab = document.createElement('button');
        adminTab.className = 'tab';
        adminTab.setAttribute('data-admin', 'true');
        adminTab.onclick = () => {
            showSection('admin');
            loadAdminStats();
        };
        adminTab.innerHTML = '<i class="fas fa-user-shield"></i> –ê–¥–º–∏–Ω';
        tabsContainer.appendChild(adminTab);
    }
    
    async function addTransaction(transaction) {
        if (!currentUser) return null;
        
        try {
            const userId = currentUser.id;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            if (transaction.amount !== undefined) {
                userBalance += transaction.amount;
            }
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            const transactionId = 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const fullTransaction = {
                ...transaction,
                id: transactionId,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ru-RU'),
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                userId: userId,
                userName: currentUser.name,
                username: currentUser.username
            };
            
            userTransactions.push(fullTransaction);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
            if (db) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await db.collection('users').doc(userId).update({
                    balance: userBalance,
                    transactions: userTransactions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±—â—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
                await db.collection('all_transactions').doc(transactionId).set({
                    ...fullTransaction,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            updateBalance();
            updateHistory();
            
            return fullTransaction;
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é', 'error');
            return null;
        }
    }
    
    async function buyStars(starsAmount) {
        try {
            const cost = starsAmount * STAR_RATE;
            const commission = cost * 0.015;
            const total = cost + commission;
            
            if (total > userBalance) {
                throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ');
            }
            
            const transaction = await addTransaction({
                type: 'stars_purchase',
                amount: -total,
                stars: starsAmount,
                cost: cost,
                commission: commission,
                total: total,
                status: 'completed',
                description: `–ü–æ–∫—É–ø–∫–∞ ${starsAmount} Telegram Stars`
            });
            
            return {
                success: true,
                stars: starsAmount,
                cost: cost,
                commission: commission,
                total: total,
                transaction: transaction
            };
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    async function createTopupRequest(cardNumber) {
        try {
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            
            if (cleanCardNumber.length < 16 || cleanCardNumber.length > 19 || !/^\d+$/.test(cleanCardNumber)) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã');
            }
            
            const maskedCard = '**** **** **** ' + cleanCardNumber.slice(-4);
            
            const transaction = await addTransaction({
                type: 'topup_request',
                amount: 0,
                cardNumber: cleanCardNumber,
                maskedCard: maskedCard,
                status: 'pending',
                description: `–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞`
            });
            
            currentTopupCard = cleanCardNumber;
            
            return {
                success: true,
                requestId: transaction.id,
                cardNumber: cleanCardNumber,
                maskedCard: maskedCard,
                transaction: transaction
            };
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    function updateHistory() {
        const historyContainer = document.getElementById('history-content');
        if (!historyContainer) return;
        
        if (userTransactions.length === 0) {
            historyContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-star"></i>
                    <p>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞</p>
                    <p style="color: var(--tg-secondary-text-color); margin-top: 8px;">–°–æ–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é</p>
                </div>
            `;
            return;
        }
        
        const sortedTransactions = [...userTransactions].sort((a, b) => {
            return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
        });
        
        let html = '<div class="history-list">';
        
        sortedTransactions.forEach(transaction => {
            if (transaction.type === 'stars_purchase') {
                const totalCost = Math.abs(transaction.total || transaction.amount || 0);
                html += `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">
                                <i class="fas fa-star" style="color: var(--star-color);"></i>
                                –ü–æ–∫—É–ø–∫–∞ Telegram Stars
                            </div>
                            <div class="history-subtitle">
                                ${transaction.date || ''} ${transaction.time || ''}
                            </div>
                            <div class="history-subtitle">
                                ${transaction.stars || 0} Stars ‚Ä¢ ${totalCost.toFixed(2)} ‚ÇΩ
                            </div>
                            <div class="history-status status-success">
                                –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                            </div>
                        </div>
                        <div class="history-amount negative">
                            -${totalCost.toFixed(2)} ‚ÇΩ
                        </div>
                    </div>
                `;
            } else if (transaction.type === 'topup_request') {
                html += `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">
                                <i class="fas fa-credit-card"></i>
                                –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                            </div>
                            <div class="history-subtitle">
                                ${transaction.date || ''} ${transaction.time || ''}
                            </div>
                            <div class="history-subtitle">
                                –ö–∞—Ä—Ç–∞: ${transaction.maskedCard || '**** **** **** ****'}
                            </div>
                            <div class="history-status status-pending">
                                –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: var(--tg-secondary-text-color);">
                                ID: ${transaction.id ? transaction.id.substring(0, 8) : 'N/A'}
                            </div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--warning-color); margin-top: 4px;">
                                –û–∂–∏–¥–∞–µ—Ç
                            </div>
                        </div>
                    </div>
                `;
            } else if (transaction.type === 'admin_balance_change') {
                html += `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">
                                <i class="fas fa-user-cog"></i>
                                ${transaction.description || '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'}
                            </div>
                            <div class="history-subtitle">
                                ${transaction.date || ''} ${transaction.time || ''}
                            </div>
                            <div class="history-subtitle">
                                ${transaction.reason ? '–ü—Ä–∏—á–∏–Ω–∞: ' + transaction.reason : ''}
                            </div>
                            <div class="history-status status-success">
                                –ê–¥–º–∏–Ω
                            </div>
                        </div>
                        <div class="history-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                            ${transaction.amount >= 0 ? '+' : ''}${transaction.amount?.toFixed(2) || '0.00'} ‚ÇΩ
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        historyContainer.innerHTML = html;
    }
    
    // –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
    async function loadAdminStats() {
        if (!isAdmin || !db) return;
        
        try {
            const usersSnapshot = await db.collection('users').get();
            const totalUsers = usersSnapshot.size;
            document.getElementById('total-users').textContent = totalUsers;
            
            const transactionsSnapshot = await db.collection('all_transactions').get();
            const totalTransactions = transactionsSnapshot.size;
            document.getElementById('total-transactions').textContent = totalTransactions;
            
            let totalStars = 0;
            let totalRevenue = 0;
            
            transactionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.type === 'stars_purchase') {
                    totalStars += data.stars || 0;
                    totalRevenue += Math.abs(data.total || data.amount || 0);
                }
            });
            
            document.getElementById('total-stars').textContent = totalStars.toLocaleString();
            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(2).replace('.', ',') + ' ‚ÇΩ';
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'error');
        }
    }
    
    async function loadAdminTransactions(filter = 'all') {
        if (!isAdmin || !db) return;
        
        const transactionsContainer = document.getElementById('admin-transactions-content');
        transactionsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
        
        try {
            let query = db.collection('all_transactions').orderBy('timestamp', 'desc').limit(50);
            
            if (filter === 'stars') {
                query = query.where('type', '==', 'stars_purchase');
            } else if (filter === 'topup') {
                query = query.where('type', 'in', ['topup_request', 'topup_completed']);
            }
            
            const snapshot = await query.get();
            
            if (snapshot.empty) {
                transactionsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-database"></i><p>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>';
                return;
            }
            
            let html = '<div class="admin-table-container"><table class="admin-table"><thead><tr>';
            html += '<th>–î–∞—Ç–∞</th>';
            html += '<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>';
            html += '<th>–¢–∏–ø</th>';
            html += '<th>–î–µ—Ç–∞–ª–∏</th>';
            html += '<th>–°—É–º–º–∞</th>';
            html += '<th>–°—Ç–∞—Ç—É—Å</th>';
            html += '</tr></thead><tbody>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                
                let dateStr = 'N/A';
                let timeStr = '';
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    dateStr = date.toLocaleDateString('ru-RU');
                    timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                }
                
                const userName = data.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const username = data.username ? `@${data.username}` : '';
                
                let typeBadge = '';
                let details = '';
                
                if (data.type === 'stars_purchase') {
                    typeBadge = '<span class="transaction-type type-stars">Stars</span>';
                    details = `${data.stars || 0} Stars<br><small>${(data.total || 0).toFixed(2)} ‚ÇΩ</small>`;
                } else if (data.type === 'topup_request') {
                    typeBadge = '<span class="transaction-type type-topup">–ó–∞—è–≤–∫–∞</span>';
                    const card = data.maskedCard || '**** ****';
                    details = `–ö–∞—Ä—Ç–∞: ${card}`;
                } else if (data.type === 'admin_balance_change') {
                    typeBadge = '<span>–ê–¥–º–∏–Ω</span>';
                    details = data.reason || '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞';
                }
                
                let amount = '';
                let amountColor = 'var(--tg-text-color)';
                if (data.amount !== undefined) {
                    if (data.amount < 0) {
                        amount = `-${Math.abs(data.amount).toFixed(2)} ‚ÇΩ`;
                        amountColor = 'var(--error-color)';
                    } else if (data.amount > 0) {
                        amount = `+${data.amount.toFixed(2)} ‚ÇΩ`;
                        amountColor = 'var(--success-color)';
                    } else {
                        amount = '0.00 ‚ÇΩ';
                    }
                }
                
                let statusBadge = '';
                if (data.status === 'completed') {
                    statusBadge = '<span class="history-status status-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>';
                } else if (data.status === 'pending') {
                    statusBadge = '<span class="history-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>';
                }
                
                html += `
                    <tr>
                        <td>
                            <div>${dateStr}</div>
                            <div style="font-size: 12px; color: var(--tg-secondary-text-color);">${timeStr}</div>
                        </td>
                        <td>
                            <div>${userName}</div>
                            <div style="font-size: 12px; color: var(--tg-secondary-text-color);">${username}</div>
                        </td>
                        <td>${typeBadge}</td>
                        <td>${details}</td>
                        <td style="font-weight: 600; color: ${amountColor};">${amount}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            transactionsContainer.innerHTML = html;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', error);
            transactionsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p></div>';
        }
    }
    
    async function loadAdminUsers() {
        if (!isAdmin || !db) return;
        
        const usersContainer = document.getElementById('admin-users-content');
        usersContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
        
        try {
            const usersSnapshot = await db.collection('users').get();
            
            if (usersSnapshot.empty) {
                usersContainer.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>';
                return;
            }
            
            let html = '<div class="admin-table-container"><table class="admin-table"><thead><tr>';
            html += '<th>ID</th>';
            html += '<th>–ò–º—è</th>';
            html += '<th>Username</th>';
            html += '<th>–ë–∞–ª–∞–Ω—Å</th>';
            html += '<th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>';
            html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
            html += '</tr></thead><tbody>';
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const userId = doc.id;
                const balance = user.balance || 0;
                
                let registrationDate = 'N/A';
                if (user.registrationDate) {
                    const date = new Date(user.registrationDate);
                    registrationDate = date.toLocaleDateString('ru-RU');
                }
                
                html += `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px;">${userId.substring(0, 12)}...</td>
                        <td>${user.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>${user.username ? '@' + user.username : '-'}</td>
                        <td style="font-weight: 600;">${balance.toFixed(2)} ‚ÇΩ</td>
                        <td>${registrationDate}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editUserBalance('${userId}', '${user.name || ''}', '${user.username || ''}', ${balance})">
                                <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            usersContainer.innerHTML = html;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            usersContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p></div>';
        }
    }
    
    function editUserBalance(userId, userName, userUsername, currentBalance) {
        editingUserId = userId;
        
        document.getElementById('edit-user-name').textContent = userName;
        document.getElementById('edit-user-username').textContent = userUsername ? '@' + userUsername : '-';
        document.getElementById('edit-current-balance').textContent = currentBalance.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('new-balance-input').value = currentBalance.toFixed(2);
        document.getElementById('balance-change-reason').value = '';
        
        openModal('editBalanceModal');
    }
    
    async function saveUserBalance() {
        if (!editingUserId || !db) return;
        
        const newBalanceInput = document.getElementById('new-balance-input');
        const reasonInput = document.getElementById('balance-change-reason');
        
        const newBalance = parseFloat(newBalanceInput.value);
        const reason = reasonInput.value.trim();
        
        if (isNaN(newBalance)) {
            showNotification('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞', 'error');
            return;
        }
        
        try {
            const userDoc = await db.collection('users').doc(editingUserId).get();
            if (!userDoc.exists) {
                showNotification('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            const userData = userDoc.data();
            const oldBalance = userData.balance || 0;
            const balanceChange = newBalance - oldBalance;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await db.collection('users').doc(editingUserId).update({
                balance: newBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            const transactionId = 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const transaction = {
                id: transactionId,
                type: 'admin_balance_change',
                amount: balanceChange,
                oldBalance: oldBalance,
                newBalance: newBalance,
                status: 'completed',
                description: `–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º`,
                reason: reason || '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
                adminName: currentUser.name,
                adminUsername: currentUser.username,
                userId: editingUserId,
                userName: userData.name,
                username: userData.username,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ru-RU'),
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            await db.collection('all_transactions').doc(transactionId).set({
                ...transaction,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userTransactions = userData.transactions || [];
            userTransactions.push(transaction);
            await db.collection('users').doc(editingUserId).update({
                transactions: userTransactions
            });
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
            if (currentUser && currentUser.id === editingUserId) {
                userBalance = newBalance;
                updateBalance();
                updateHistory();
            }
            
            showNotification('–£—Å–ø–µ—Ö', `–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${newBalance.toFixed(2)} ‚ÇΩ`, 'success');
            closeModal('editBalanceModal');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (document.getElementById('admin-users-section') && !document.getElementById('admin-users-section').classList.contains('hidden')) {
                loadAdminUsers();
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }
    
    function redirectToPayment() {
        if (!currentTopupCard) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω', 'error');
            return;
        }
        
        const userId = currentUser?.id || 'unknown';
        
        localStorage.setItem('last_payment_attempt', JSON.stringify({
            userId: userId,
            cardNumber: currentTopupCard,
            timestamp: new Date().toISOString(),
            requestId: `TP${Date.now().toString().slice(-6)}`
        }));
        
        window.open(`https://yoomoney.ru/to/4100117160998714/0?label=topup_${userId}`, '_blank');
        
        closeModal('paymentModal');
        
        document.getElementById('topup-result').classList.remove('hidden');
        document.getElementById('topup-form').style.display = 'none';
        document.getElementById('topup-request-id').textContent = `TP${Date.now().toString().slice(-6)}`;
        
        showNotification('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ÆMoney –¥–ª—è –æ–ø–ª–∞—Ç—ã', 'success');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            tg.expand();
            initTheme();
            
            await initUser();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ Stars
            const starsInput = document.getElementById('stars-amount');
            if (starsInput) {
                starsInput.addEventListener('input', updateStarsCost);
                updateStarsCost();
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
            const cardInput = document.getElementById('topup-card-number');
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(.{4})/g, '$1 ').trim();
                    e.target.value = value.substring(0, 19);
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        closeModal(modal.id);
                    });
                }
            });
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 'error');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º
    document.getElementById('buy-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentUser) {
            showNotification('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
            return;
        }
        
        const starsInput = document.getElementById('stars-amount');
        const stars = parseInt(starsInput.value);
        
        if (stars < 10 || stars > 100000) {
            showNotification('–û—à–∏–±–∫–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Stars –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 10 –¥–æ 100,000', 'error');
            return;
        }
        
        const cost = stars * STAR_RATE;
        const commission = cost * 0.015;
        const total = cost + commission;
        
        if (total > userBalance) {
            showNotification('–û—à–∏–±–∫–∞', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ: ${total.toFixed(2)} ‚ÇΩ, –¥–æ—Å—Ç—É–ø–Ω–æ: ${userBalance.toFixed(2)} ‚ÇΩ`, 'error');
            return;
        }
        
        try {
            const result = await buyStars(stars);
            
            if (result.success) {
                document.getElementById('purchased-stars').textContent = stars;
                document.getElementById('buy-result').classList.remove('hidden');
                document.getElementById('buy-form').style.display = 'none';
                
                showNotification('–£—Å–ø–µ—à–Ω–æ!', `–ö—É–ø–ª–µ–Ω–æ ${stars} Telegram Stars`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞', result.error, 'error');
            }
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–∫—É–ø–∫—É', 'error');
        }
    });
    
    document.getElementById('topup-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentUser) {
            showNotification('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
            return;
        }
        
        const cardInput = document.getElementById('topup-card-number');
        const cardNumber = cardInput.value.replace(/\s/g, '');
        
        if (cardNumber.length < 16 || cardNumber.length > 19 || !/^\d+$/.test(cardNumber)) {
            showNotification('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã', 'error');
            return;
        }
        
        try {
            const result = await createTopupRequest(cardNumber);
            
            if (result.success) {
                document.getElementById('payment-card-number').textContent = result.maskedCard;
                openModal('paymentModal');
            } else {
                showNotification('–û—à–∏–±–∫–∞', result.error, 'error');
            }
            
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É', 'error');
        }
    });
    
    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö
    if (navigator.vibrate) {
        document.querySelectorAll('button, .tab, .calc-btn').forEach(element => {
            element.addEventListener('click', function() {
                navigator.vibrate(10);
            });
        });
    }
    </script>
</body>
</html>